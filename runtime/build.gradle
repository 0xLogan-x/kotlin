import org.jetbrains.kotlin.CompileCppToBitcode

// TODO: consider using some Gradle plugins to build and test


task build(type: CompileCppToBitcode) {
    name 'runtime'
    srcRoot file('src/main')

    dependsOn ':common:compileHash'
    compilerArgs '-I' + project.file('../common/src/hash/headers') // TODO: copy-pasted from 'common'
    linkerArgs project.file('../common/build/hash.bc').path
}

task test {
    dependsOn build

    doLast {
        exec {
	    commandLine "$llvmInstallPath/bin/clang", 'src/test/c/main.c', '-c', '-emit-llvm', '-o', "$buildDir/main.bc"
	}
        exec {
	    commandLine "$llvmInstallPath/bin/clang++", build.outFile, "$buildDir/main.bc", '-o', "$buildDir/main"
	}
	exec {
	    workingDir buildDir
	    commandLine './main'
	}
    }
}

task clean << {
    delete buildDir
}
